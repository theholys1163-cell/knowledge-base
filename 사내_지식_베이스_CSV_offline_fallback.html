<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사내 지식 베이스 (CSV 연동 · 오프라인 폴백)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    ::-webkit-scrollbar{ width:10px; height:10px }
    ::-webkit-scrollbar-track{ background:#f1f1f1; border-radius:10px }
    ::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:10px }
    ::-webkit-scrollbar-thumb:hover{ background:#94a3b8 }
    .prose{ max-width:100% }
    .prose h2{ font-size:1.5rem; font-weight:700; margin-bottom:1rem; border-bottom:2px solid #e2e8f0; padding-bottom:.5rem }
    .prose h3{ font-size:1.25rem; font-weight:600; margin-top:1.5rem; margin-bottom:.5rem }
    .prose p{ margin-bottom:1rem; line-height:1.6 }
    .prose ul{ list-style-type:disc; margin-left:1.5rem; margin-bottom:1rem }
    .prose li{ margin-bottom:.5rem }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">사내 지식 베이스</h1>
      <p class="text-gray-600 mt-2">CSV(웹에 게시) + 오프라인 폴백(업로드/붙여넣기)</p>
    </header>

    <!-- 컨트롤 바 -->
    <div class="mb-6 flex flex-col md:flex-row gap-3 md:items-center">
      <input id="search-input" type="text" placeholder="검색어 입력 (예: 'TTA', '공급자적합성')..." class="flex-1 p-4 border border-gray-300 rounded-lg shadow-sm text-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      <div class="flex gap-2">
        <button id="reload-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">온라인 다시 시도</button>
        <label class="px-4 py-2 rounded-lg bg-white border text-gray-700 hover:bg-gray-50 cursor-pointer">
          파일 업로드
          <input id="file-input" type="file" accept=".csv" class="hidden">
        </label>
        <button id="paste-toggle" class="px-4 py-2 rounded-lg bg-white border text-gray-700 hover:bg-gray-50">CSV 붙여넣기</button>
        <button id="demo-btn" class="px-4 py-2 rounded-lg bg-white border text-gray-700 hover:bg-gray-50">데모 데이터</button>
      </div>
    </div>

    <!-- 붙여넣기 패널 -->
    <div id="paste-panel" class="hidden mb-6">
      <div class="bg-white rounded-2xl shadow p-4 space-y-3">
        <p class="text-sm text-gray-600">시트 접근이 제한되거나 CORS로 막힐 때, CSV 원문을 아래에 붙여넣어 주세요.</p>
        <textarea id="paste-textarea" class="w-full h-40 p-3 border rounded-lg font-mono text-sm" placeholder="여기에 CSV 원문을 붙여넣기"></textarea>
        <div class="flex justify-end">
          <button id="paste-apply" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">붙여넣기 적용</button>
        </div>
      </div>
    </div>

    <!-- 본문 -->
    <div class="flex flex-col md:flex-row gap-8">
      <!-- 검색 결과 -->
      <div class="md:w-1/3 bg-white p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h2 class="text-xl font-semibold">검색 결과</h2>
        </div>
        <div id="results-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
          <p id="results-placeholder" class="text-gray-500">데이터를 불러오는 중입니다...</p>
        </div>
      </div>

      <!-- 상세 -->
      <div class="md:w-2/3 bg-white p-6 md:p-8 rounded-2xl shadow-lg">
        <div id="detail-view" class="max-h-[60vh] overflow-y-auto pr-2 prose">
          <h2 id="detail-title" class="text-2xl font-bold text-gray-800">항목을 선택하세요</h2>
          <div id="detail-content" class="mt-4 text-gray-700">
            <p>왼쪽 검색 결과에서 항목을 클릭하면 여기에 상세 내용이 표시됩니다.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ====== 구성 ======
  const GOOGLE_SHEET_CSV_URL_1 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_3-COhRiH_d5-aMwdrz4f7xZpUJTOubdg6pHJr1IfrXUX1xP_pvY1KtSA4cO3r3a0R7lsxfF3A43d/pub?output=csv';
  const GOOGLE_SHEET_CSV_URL_2 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvvO39hKuuGQQ5us4MUWVgNAY0Kf3ol59n4s1pF77Ppugto594JmuYxGNgxLxl7_I6beHQ4FEsuxKt/pub?output=csv';

  const headersMap_Gyeoljae = {
    type: '결재문서',
    required: { id:'문서번호', title:'제목', category:'문서분류', author:'기안자', department:'기안부서', status:'문서상태' },
    optional: { draftDate:'기안일자', arrivalDate:'도착일자', endDate:'종결일자', readStatus:'열람' },
  };
  const headersMap_Injeung = {
    type: '인증문서',
    required: { id:'번호', productName:'기자재명칭', modelName:'모델명', company:'상호', certType:'인증 종류', certNumber:'인증번호(또는 성적서 번호)' },
    optional: { country:'제조국가', certDate:'인증 연월일', manufacturer:'제조자', derivedModels:'파생모델명', testStandard:'시험규격', certStatus:'인증상태', remarks:'비고', factory1:'제조공장1', factory2:'제조공장2', factory3:'제조공장3' },
  };

  let wikiData = [];
  const $ = (id)=>document.getElementById(id);
  const searchInput = $('search-input');
  const resultsList = $('results-list');
  const resultsPlaceholder = $('results-placeholder');
  const detailTitle = $('detail-title');
  const detailContent = $('detail-content');
  const fileInput = $('file-input');
  const pasteToggle = $('paste-toggle');
  const pastePanel = $('paste-panel');
  const pasteTextarea = $('paste-textarea');
  const pasteApply = $('paste-apply');
  const reloadBtn = $('reload-btn');
  const demoBtn = $('demo-btn');

  function parseCSV(text){
    const data=[]; const rows=[]; let currentRow=[]; let currentField=''; let inQuotes=false;
    if(text.charCodeAt(0)===0xFEFF){ text=text.substring(1); }
    for(let i=0;i<text.length;i++){
      const c=text[i], n=text[i+1];
      if(inQuotes){
        if(c=='"' && n=='"'){ currentField+='"'; i++; }
        else if(c=='"'){ inQuotes=false; }
        else { currentField+=c; }
      }else{
        if(c=='"'){ inQuotes=true; }
        else if(c==','){ currentRow.push(currentField); currentField=''; }
        else if(c=='\n' || c=='\r'){ currentRow.push(currentField); rows.push(currentRow); currentRow=[]; currentField=''; if(c=='\r' && n=='\n') i++; }
        else { currentField+=c; }
      }
    }
    if(currentField) currentRow.push(currentField);
    if(currentRow.length>0) rows.push(currentRow);
    if(rows.length<2) return [];
    const headers = rows[0].map(h=>h.toLowerCase().trim());
    for(let i=1;i<rows.length;i++){
      const r=rows[i]; if(r.length!==headers.length) continue;
      const obj={}; for(let j=0;j<headers.length;j++){ obj[headers[j]] = r[j] || ''; }
      data.push(obj);
    }
    return data;
  }

  function processCSVData(csvData, headersMap){
    const processed=[];
    const indices={}; const allHeaders={...headersMap.required, ...headersMap.optional};
    for(const key in allHeaders){
      const headerName = allHeaders[key].toLowerCase();
      const exists = csvData.length>0 ? csvData[0].hasOwnProperty(headerName) : false;
      if(headersMap.required[key] && !exists){
        // 필수 컬럼이 한 번이라도 없으면 전체를 스킵하는 대신, 조용히 continue 하여 다른 소스는 살린다.
        console.warn(`[${headersMap.type}] 필수 헤더 누락: "${allHeaders[key]}"`);
      }
      indices[key]=headerName;
    }
    for(const row of csvData){
      const item={ id: row[indices.id] || `${headersMap.type}-${processed.length}`, title:'', category:'', summary:'', content:'' };
      if(headersMap.type==='결재문서'){
        item.title = row[indices.title] || '제목 없음';
        item.category = `결재문서: ${row[indices.category] || '분류 없음'}`;
        item.summary = `기안자: ${row[indices.author] || 'N/A'} (${row[indices.department] || 'N/A'}) | 상태: ${row[indices.status] || 'N/A'}`;
        item.content = `
          <p><strong>문서번호:</strong> ${row[indices.id] || 'N/A'}</p>
          <p><strong>문서분류:</strong> ${row[indices.category] || 'N/A'}</p>
          <p><strong>기안부서:</strong> ${row[indices.department] || 'N/A'}</p>
          <p><strong>기안자:</strong> ${row[indices.author] || 'N/A'}</p>
          <p><strong>문서상태:</strong> ${row[indices.status] || 'N/A'}</p>
          <hr class="my-4 border-gray-200">
          <p><strong>기안일자:</strong> ${row[indices.draftdate] || 'N/A'}</p>
          <p><strong>도착일자:</strong> ${row[indices.arrivaldate] || 'N/A'}</p>
          <p><strong>종결일자:</strong> ${row[indices.enddate] || 'N/A'}</p>
          <p><strong>열람:</strong> ${row[indices.readstatus] || 'N/A'}</p>`;
      }else{
        item.title = `${row[indices.productname] || '기자재명 없음'} (모델명: ${row[indices.modelname] || '모델명 없음'})`;
        item.category = `인증문서: ${row[indices.certtype] || 'N/A'}`;
        item.summary = `상호: ${row[indices.company] || '상호 없음'} | 인증번호: ${row[indices.certnumber] || 'N/A'}`;
        item.content = `
          <p><strong>상호:</strong> ${row[indices.company] || 'N/A'}</p>
          <p><strong>기자재명칭:</strong> ${row[indices.productname] || 'N/A'}</p>
          <p><strong>모델명:</strong> ${row[indices.modelname] || 'N/A'}</p>
          <p><strong>파생모델명:</strong> ${row[indices.derivedmodels] || 'N/A'}</p>
          <p><strong>제조자:</strong> ${row[indices.manufacturer] || 'N/A'}</p>
          <p><strong>제조국가:</strong> ${row[indices.country] || 'N/A'}</p>
          <hr class="my-4 border-gray-200">
          <p><strong>인증 종류:</strong> ${row[indices.certtype] || 'N/A'}</p>
          <p><strong>인증번호:</strong> ${row[indices.certnumber] || 'N/A'}</p>
          <p><strong>시험규격:</strong> ${row[indices.teststandard] || 'N/A'}</p>
          <p><strong>인증 연월일:</strong> ${row[indices.certdate] || 'N/A'}</p>
          <p><strong>인증상태:</strong> ${row[indices.certstatus] || 'N/A'}</p>
          <p><strong>비고:</strong> ${row[indices.remarks] || 'N/A'}</p>
          <hr class="my-4 border-gray-200">
          <p><strong>제조공장1:</strong> ${row[indices.factory1] || 'N/A'}</p>
          <p><strong>제조공장2:</strong> ${row[indices.factory2] || 'N/A'}</p>
          <p><strong>제조공장3:</strong> ${row[indices.factory3] || 'N/A'}</p>`;
      }
      processed.push(item);
    }
    return processed;
  }

  function renderResults(term=''){
    resultsList.innerHTML='';
    term = (term||'').toLowerCase();
    const filtered = wikiData.filter(it =>
      it.title.toLowerCase().includes(term) ||
      it.summary.toLowerCase().includes(term) ||
      it.category.toLowerCase().includes(term) ||
      it.content.toLowerCase().includes(term)
    );
    if(filtered.length===0){
      resultsList.innerHTML = term
        ? `<p class="text-gray-500">'${term}'에 대한 검색 결과가 없습니다.</p>`
        : `<p class="text-gray-500">표시할 데이터가 없습니다.</p>`;
      return;
    }
    for(const item of filtered){
      const div=document.createElement('div');
      div.className='p-3 border rounded-lg hover:bg-indigo-50 cursor-pointer transition';
      div.innerHTML=`<h3 class="font-semibold text-indigo-700">${item.title}</h3>
        <p class="text-sm text-gray-600">${item.category}</p>
        <p class="text-sm text-gray-600">${item.summary}</p>`;
      div.addEventListener('click',()=>renderDetail(item));
      resultsList.appendChild(div);
    }
  }

  function renderDetail(item){
    detailTitle.textContent=item.title;
    detailContent.innerHTML=item.content;
  }

  async function fetchText(url){
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    return res.text();
  }

  async function tryOnlineLoad(){
    resultsPlaceholder.textContent="Google Sheets에서 데이터를 불러오는 중입니다...";
    try{
      const [t1,t2] = await Promise.all([fetchText(GOOGLE_SHEET_CSV_URL_1), fetchText(GOOGLE_SHEET_CSV_URL_2)]);
      const csv1 = parseCSV(t1);
      const csv2 = parseCSV(t2);
      const p1 = processCSVData(csv1, headersMap_Gyeoljae);
      const p2 = processCSVData(csv2, headersMap_Injeung);
      wikiData = p1.concat(p2);
      resultsPlaceholder.remove();
      renderResults('');
      return true;
    }catch(err){
      console.warn('온라인 로드 실패:', err);
      resultsPlaceholder.textContent = "온라인 로드 실패. 파일 업로드나 붙여넣기 기능을 사용하세요.";
      resultsPlaceholder.classList.add('text-red-500');
      return false;
    }
  }

  // ====== 이벤트 ======
  window.addEventListener('DOMContentLoaded', async () => {
    searchInput.addEventListener('keyup', (e)=>renderResults(e.target.value));
    pasteToggle.addEventListener('click', ()=> pastePanel.classList.toggle('hidden'));
    pasteApply.addEventListener('click', ()=>{
      const txt = pasteTextarea.value.trim();
      if(!txt) return;
      const parsed = parseCSV(txt);
      wikiData = processCSVData(parsed, headersMap_Gyeoljae).concat(processCSVData(parsed, headersMap_Injeung));
      renderResults('');
      resultsPlaceholder && resultsPlaceholder.remove();
    });
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const text = await f.text();
      const parsed = parseCSV(text);
      wikiData = processCSVData(parsed, headersMap_Gyeoljae).concat(processCSVData(parsed, headersMap_Injeung));
      renderResults('');
      resultsPlaceholder && resultsPlaceholder.remove();
      fileInput.value='';
    });
    reloadBtn.addEventListener('click', tryOnlineLoad);
    demoBtn.addEventListener('click', ()=>{
      const demo = `문서번호,제목,문서분류,기안자,기안부서,문서상태,기안일자
A-001,대기전력 제도 개선(안),보고서,박민준,QC팀,종결,2025-05-01
번호,기자재명칭,모델명,상호,인증 종류,인증번호(또는 성적서 번호),시험규격,제조국가
1,홈게이트웨이,IGW-200D,에이치디씨랩스,대기전력,TTA-N-13-0435,KS C IEC 62301,대한민국`;
      const parsed = parseCSV(demo);
      wikiData = processCSVData(parsed, headersMap_Gyeoljae).concat(processCSVData(parsed, headersMap_Injeung));
      renderResults('');
      resultsPlaceholder && resultsPlaceholder.remove();
    });

    // 초기에 온라인 로드 시도 (file:// 환경이면 실패 가능)
    await tryOnlineLoad();
  });
  </script>
</body>
</html>
